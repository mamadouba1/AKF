<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AKF Â· Tableau de bord</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
<style>
:root{
  --ink:#0f1923;--ink2:#2a3a4a;--mu:#6b7d8f;--ln:#e2e8ef;--bg:#f0f4f8;--wh:#fff;
  --gr:#0e7a45;--gr2:#16a85f;--gp:#e8f5ee;
  --go:#b07d0a;--gop:#fdf4dd;
  --re:#c0392b;--rep:#fdf0ee;
  --bl:#1c5fad;--blp:#e8f0fc;
  --pu:#7c3aed;--pup:#f3effe;
  --R:13px;
  --sh:0 1px 3px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06);
  --shm:0 2px 8px rgba(0,0,0,.08),0 8px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh}
.layout{display:flex;min-height:100vh}

/* â”€â”€ SIDEBAR â”€â”€ */
.sb{width:256px;flex-shrink:0;background:var(--ink);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto}
.sl{padding:14px 16px 12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px}
.sl-logo{width:46px;height:46px;border-radius:10px;background:var(--gr);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
.sl h2{font-size:.58rem;font-weight:700;color:rgba(255,255,255,.3);letter-spacing:.1em;text-transform:uppercase}
.sl p{font-size:.78rem;color:rgba(255,255,255,.88);font-weight:600;margin-top:1px}
.snl{padding:10px 16px 3px;font-size:.57rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.2)}
nav{padding:0 8px}
.ni{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;color:rgba(255,255,255,.44);font-size:.8rem;font-weight:500;cursor:pointer;transition:all .17s;margin-bottom:2px}
.ni:hover{color:rgba(255,255,255,.9);background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.12)}
.ni-ic{font-size:13px;width:18px;text-align:center;flex-shrink:0}
.ni-b{margin-left:auto;background:rgba(255,255,255,.12);color:rgba(255,255,255,.55);font-size:.62rem;padding:2px 7px;border-radius:10px;font-weight:700}
.sync-row{padding:8px 12px 4px}
.sync-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;border-radius:8px;background:rgba(14,122,69,.25);border:1px solid rgba(14,122,69,.4);color:rgba(255,255,255,.75);font-size:.74rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.sync-btn:hover{background:rgba(14,122,69,.45)}
.sync-btn:disabled{opacity:.5;cursor:not-allowed}
.sfoot{padding:12px 16px 16px;font-size:.65rem;color:rgba(255,255,255,.16);margin-top:auto}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;overflow-x:hidden;padding:22px 26px}
.tc{display:none}.tc.on{display:block;animation:fu .28s both}
@keyframes fu{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{display:flex;align-items:flex-start;gap:10px;margin-bottom:18px;flex-wrap:wrap}
.tt h1{font-family:'DM Serif Display',serif;font-size:1.45rem}
.tt p{font-size:.78rem;color:var(--mu);margin-top:2px}
.ta{display:flex;gap:8px;margin-left:auto;align-items:center;flex-wrap:wrap}

/* â”€â”€ KPIs â”€â”€ */
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(148px,1fr));gap:12px;margin-bottom:18px}
.kpi{background:var(--wh);border-radius:var(--R);padding:14px 16px;box-shadow:var(--sh);cursor:pointer;transition:all .18s;border:2px solid transparent}
.kpi:hover{box-shadow:var(--shm);transform:translateY(-1px)}
.kpi.on{border-color:var(--gr)}
.kh{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ki{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.kt{font-size:.62rem;font-weight:700;padding:2px 8px;border-radius:10px}
.kv{font-size:1.8rem;font-weight:800;line-height:1}
.kl{font-size:.72rem;color:var(--mu);margin-top:3px}
.kb{height:3px;background:var(--ln);border-radius:2px;margin-top:10px}
.kbf{height:3px;border-radius:2px;transition:width .4s}

/* â”€â”€ CHARTS â”€â”€ */
.cr2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px}
.cr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:18px}
@media(max-width:920px){.cr2,.cr3{grid-template-columns:1fr}}
.card{background:var(--wh);border-radius:var(--R);box-shadow:var(--sh);padding:16px}
.ct{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.ctl{font-size:.8rem;font-weight:700}
.cf{border:1.5px solid var(--ln);border-radius:7px;padding:3px 7px;font-size:.7rem;font-family:inherit;background:var(--bg);outline:none}
.cw{height:160px;position:relative}

/* â”€â”€ TABLE CARD â”€â”€ */
.tcard{background:var(--wh);border-radius:var(--R);box-shadow:var(--sh);overflow:hidden}
.toolbar{display:flex;align-items:center;gap:8px;padding:12px 14px;border-bottom:1px solid var(--ln);flex-wrap:wrap}
.sw{position:relative}
.sw input{border:1.5px solid var(--ln);border-radius:8px;padding:6px 10px 6px 30px;font-size:.78rem;width:175px;outline:none;font-family:inherit;background:var(--bg);transition:border .15s}
.sw input:focus{border-color:var(--gr);background:#fff}
.sw::before{content:'ğŸ”';position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:11px}
.flt{border:1.5px solid var(--ln);border-radius:8px;padding:5px 8px;font-size:.74rem;font-family:inherit;background:var(--bg);outline:none;cursor:pointer;transition:border .15s}
.flt:focus{border-color:var(--gr)}
.rc{margin-left:auto;font-size:.72rem;color:var(--mu);font-weight:600;white-space:nowrap}
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.8rem}
thead th{background:var(--bg);padding:9px 12px;text-align:left;font-size:.64rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--mu);white-space:nowrap;cursor:pointer;user-select:none;border-bottom:2px solid var(--ln)}
thead th:hover{color:var(--ink)}
thead th.s{color:var(--gr)}
tbody tr{border-bottom:1px solid var(--ln);transition:background .12s}
tbody tr:hover{background:var(--bg)}
tbody td{padding:9px 12px;vertical-align:middle}
.pag{display:flex;align-items:center;gap:4px;padding:10px 14px;border-top:1px solid var(--ln);flex-wrap:wrap}
.pag button{border:1.5px solid var(--ln);background:var(--wh);border-radius:7px;padding:4px 9px;font-size:.74rem;cursor:pointer;font-family:inherit;transition:all .13s}
.pag button:hover:not([disabled]){border-color:var(--gr);color:var(--gr)}
.pag button.on{background:var(--gr);color:#fff;border-color:var(--gr)}
.pag button[disabled]{opacity:.35;cursor:not-allowed}
.pi{font-size:.7rem;color:var(--mu);margin-left:auto}

/* â”€â”€ ATOMS â”€â”€ */
.av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.73rem;color:#fff;flex-shrink:0}
.pill{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:20px;font-size:.7rem;font-weight:600;white-space:nowrap}
.tn{font-weight:600;font-size:.82rem}
.tsub{font-size:.68rem;color:var(--mu);margin-top:1px}
.btn{border:none;border-radius:8px;padding:7px 14px;font-size:.76rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;display:inline-flex;align-items:center;gap:5px}
.bg{background:var(--gr);color:#fff}.bg:hover{background:var(--gr2)}
.bgh{background:var(--bg);color:var(--ink2);border:1.5px solid var(--ln)}.bgh:hover{border-color:var(--gr);color:var(--gr)}
.br{background:var(--rep);color:var(--re)}.br:hover{background:var(--re);color:#fff}
.bsm{padding:4px 9px;font-size:.71rem;border-radius:7px}

/* â”€â”€ MODALS â”€â”€ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.ov.open{opacity:1;pointer-events:all}
.mbox{background:var(--wh);border-radius:16px;padding:24px;width:min(540px,94vw);max-height:88vh;overflow-y:auto;box-shadow:var(--shm)}
.mbox.sm{width:min(360px,94vw)}
.mtit{display:flex;align-items:center;justify-content:space-between;font-family:'DM Serif Display',serif;font-size:1.05rem;margin-bottom:16px}
.mc{background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--mu);padding:2px 6px;border-radius:5px}
.mc:hover{background:var(--bg)}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.fr{display:flex;flex-direction:column;gap:4px}
.fr.full{grid-column:1/-1}
.fr label{font-size:.71rem;font-weight:600;color:var(--mu)}
.fr input,.fr select,.fr textarea{border:1.5px solid var(--ln);border-radius:8px;padding:7px 10px;font-size:.8rem;font-family:inherit;outline:none;transition:border .15s;background:var(--bg)}
.fr input:focus,.fr select:focus,.fr textarea:focus{border-color:var(--gr);background:#fff}
.fa{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}
/* detail modal */
.dbox{background:var(--wh);border-radius:16px;padding:22px;width:min(480px,94vw);max-height:88vh;overflow-y:auto;box-shadow:var(--shm)}
.dh{display:flex;align-items:center;gap:12px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--ln)}
.dav{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1rem;color:#fff;flex-shrink:0}
.dg{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.di{background:var(--bg);border-radius:9px;padding:9px 12px}
.dl{font-size:.63rem;font-weight:700;color:var(--mu);text-transform:uppercase;letter-spacing:.07em;margin-bottom:2px}
.dv{font-size:.8rem;font-weight:500;word-break:break-word}

/* â”€â”€ MAP â”€â”€ */
#map{height:320px;border-radius:10px;overflow:hidden}
.mfbar{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.qbar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.qc{border:1.5px solid var(--ln);background:var(--wh);border-radius:20px;padding:3px 12px;font-size:.72rem;cursor:pointer;font-family:inherit;transition:all .15s}
.qc.on{background:var(--gr);color:#fff;border-color:var(--gr)}

/* â”€â”€ TOAST â”€â”€ */
.tw-wrap{position:fixed;bottom:22px;right:22px;z-index:3000;display:flex;flex-direction:column;gap:7px}
.toast{background:#0f1923;color:#fff;padding:10px 16px;border-radius:10px;font-size:.8rem;font-weight:600;box-shadow:0 4px 16px rgba(0,0,0,.2);animation:fu .3s both}

/* â”€â”€ LOADING â”€â”€ */
.ldov{position:fixed;inset:0;background:rgba(15,25,35,.8);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.ldov.hide{display:none}
.spin{width:42px;height:42px;border:4px solid rgba(255,255,255,.15);border-top-color:var(--gr);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.ldtxt{color:rgba(255,255,255,.8);font-size:.85rem;font-weight:500}
</style>
</head>
<body>

<div class="ldov" id="ldov">
  <div class="spin"></div>
  <div class="ldtxt" id="ldtxt">Chargement des donnÃ©es Google Sheetsâ€¦</div>
</div>

<div class="layout">

<!-- SIDEBAR -->
<div class="sb">
  <div class="sl">
    <div class="sl-logo">
    <img src="https://i.postimg.cc/MG6xqtLp/8f8dd0a7_ae8f_4fbc_8820_8ada8583a6f8.jpg" alt="Logo" style="height:50px;">
    </div>
    <div><h2></h2><p>Association des KÃ©bÃ©merois de France - AKF</p></div>
  </div>
  <div class="sync-row">
    <button class="sync-btn" id="sync-btn" onclick="syncData()">ğŸ”„ </button>
  </div>
  <div class="snl">Navigation</div>
  <nav>
    <div class="ni on" id="ni-membres" onclick="goTab('membres',this)"><span class="ni-ic">ğŸ‘¥</span>Tableau de bord<span class="ni-b" id="nb-m">0</span></div>
    <div class="ni" id="ni-liste" onclick="goTab('liste',this)"><span class="ni-ic">ğŸ“‹</span>Liste complÃ¨te<span class="ni-b" id="nb-l">0</span></div>
    <div class="ni" id="ni-carte" onclick="goTab('carte',this)"><span class="ni-ic">ğŸ—ºï¸</span>Carte</div>
    <div class="ni" id="ni-taches" onclick="goTab('taches',this)"><span class="ni-ic">âœ…</span>TÃ¢ches<span class="ni-b" id="nb-t">0</span></div>
  </nav>
  <div class="sfoot" id="sfoot">DonnÃ©es locales</div>
</div>

<!-- MAIN -->
<main class="main">

<!-- â•â• TAB MEMBRES â•â• -->
<div class="tc on" id="tab-membres">
  <div class="topbar">
    <div class="tt"><h1>Tableau de bord membres</h1><p>Vue d'ensemble Â· AKF 2026</p></div>
    <div class="ta">
      <button class="btn bgh" onclick="expCSV('membres')">â¬‡ï¸ CSV</button>
      <button class="btn bg" onclick="openOv('am')">ï¼‹ Ajouter</button>
    </div>
  </div>
  <div class="kpis">
    <div class="kpi" onclick="kpiM('',this)">
      <div class="kh"><div class="ki" style="background:#e8f5ee">ğŸ‘¥</div><span class="kt" style="background:#e8f5ee;color:var(--gr)">Total</span></div>
      <div class="kv" style="color:var(--gr)" id="kv0">0</div><div class="kl">Inscrits</div>
      <div class="kb"><div class="kbf" style="background:var(--gr);width:100%"></div></div>
    </div>
    <div class="kpi" onclick="kpiM('Professionnel',this)">
      <div class="kh"><div class="ki" style="background:var(--blp)">ğŸ’¼</div><span class="kt" style="background:var(--blp);color:var(--bl)" id="kp1">0%</span></div>
      <div class="kv" style="color:var(--bl)" id="kv1">0</div><div class="kl">Professionnels</div>
      <div class="kb"><div class="kbf" id="kb1" style="background:var(--bl)"></div></div>
    </div>
    <div class="kpi" onclick="kpiM('Ã‰tudiant',this)">
      <div class="kh"><div class="ki" style="background:var(--gop)">ğŸ“</div><span class="kt" style="background:var(--gop);color:var(--go)" id="kp2">0%</span></div>
      <div class="kv" style="color:var(--go)" id="kv2">0</div><div class="kl">Ã‰tudiants</div>
      <div class="kb"><div class="kbf" id="kb2" style="background:var(--go)"></div></div>
    </div>
    <div class="kpi" onclick="kpiM('Autre',this)">
      <div class="kh"><div class="ki" style="background:#f3f4f6">ğŸ”¹</div><span class="kt" style="background:#f3f4f6;color:#374151" id="kp3">0%</span></div>
      <div class="kv" style="color:#374151" id="kv3">0</div><div class="kl">Autres</div>
      <div class="kb"><div class="kbf" id="kb3" style="background:#374151"></div></div>
    </div>
  </div>
  <div class="cr3">
    <div class="card"><div class="ct"><span class="ctl">Statuts</span><select class="cf" id="cf1" onchange="drawChM()"><option value="">Tous</option><option>Professionnel</option><option>Ã‰tudiant</option><option>Autre</option></select></div><div class="cw"><canvas id="ch1"></canvas></div></div>
    <div class="card"><div class="ct"><span class="ctl">ArrivÃ©es par annÃ©e</span><select class="cf" id="cf2" onchange="drawChM()"><option value="">Tous</option><option>Professionnel</option><option>Ã‰tudiant</option><option>Autre</option></select></div><div class="cw"><canvas id="ch2"></canvas></div></div>
    <div class="card"><div class="ct"><span class="ctl">Top villes</span></div><div id="tvilles" style="overflow-y:auto;max-height:165px"></div></div>
  </div>
  <div class="tcard">
    <div class="toolbar">
      <div class="sw"><input type="search" id="s1" placeholder="Rechercherâ€¦" oninput="applyFM()"></div>
      <select class="flt" id="f1s" onchange="applyFM()"><option value="">Tous statuts</option><option>Professionnel</option><option>Ã‰tudiant</option><option>Autre</option></select>
      <select class="flt" id="f1d" onchange="applyFM()"><option value="">Participation</option><option value="Oui">Oui</option><option value="Non">Non</option></select>
      <select class="flt" id="f1x" onchange="applyFM()"><option value="">Tous genres</option><option>Homme</option><option>Femme</option></select>
      <select class="flt" id="f1v" onchange="applyFM()"><option value="">Toutes villes</option></select>
      <select class="flt" id="f1a" onchange="applyFM()"><option value="">Toutes annÃ©es</option></select>
      <span class="rc" id="rc1">0 membres</span>
    </div>
    <div class="tw"><table>
      <thead><tr>
        <th onclick="srt('M','nom')" class="s">NOM â†•</th>
        <th onclick="srt('M','ville')">VILLE â†•</th>
        <th>CONTACT</th>
        <th onclick="srt('M','statut')">STATUT â†•</th>
        <th>SPÃ‰CIALITÃ‰</th>
        <th onclick="srt('M','annee_arrivee')">ARRIVÃ‰E â†•</th>
        <th>PART.</th><th>VÃ‰RIF.</th><th></th>
      </tr></thead>
      <tbody id="tb1"></tbody>
    </table></div>
    <div class="pag" id="pg1"></div>
  </div>
</div>

<!-- â•â• TAB LISTE â•â• -->
<div class="tc" id="tab-liste">
  <div class="topbar">
    <div class="tt"><h1>Liste complÃ¨te</h1><p>Tous les inscrits AKF</p></div>
    <div class="ta">
      <button class="btn bgh" onclick="expCSV('liste')">â¬‡ï¸ CSV</button>
      <button class="btn bg" onclick="openOv('am')">ï¼‹ Ajouter</button>
    </div>
  </div>
  <div class="tcard">
    <div class="toolbar">
      <div class="sw"><input type="search" id="s2" placeholder="Rechercherâ€¦" oninput="applyFM2()"></div>
      <select class="flt" id="f2s" onchange="applyFM2()"><option value="">Tous statuts</option><option>Professionnel</option><option>Ã‰tudiant</option><option>Autre</option></select>
      <select class="flt" id="f2v" onchange="applyFM2()"><option value="">Toutes villes</option></select>
      <select class="flt" id="f2q" onchange="applyFM2()"><option value="">Tous quartiers</option></select>
      <select class="flt" id="f2d" onchange="applyFM2()"><option value="">Participation</option><option value="Oui">Oui</option><option value="Non">Non</option></select>
      <select class="flt" id="f2a" onchange="applyFM2()"><option value="">Toutes annÃ©es</option></select>
      <span class="rc" id="rc2">0 membres</span>
    </div>
    <div class="tw"><table>
      <thead><tr>
        <th onclick="srt('M2','nom')">NOM â†•</th>
        <th onclick="srt('M2','ville')">VILLE â†•</th>
        <th>TÃ‰LÃ‰PHONE</th><th>EMAIL</th>
        <th onclick="srt('M2','statut')">STATUT â†•</th>
        <th>SPÃ‰CIALITÃ‰</th><th>QUARTIER</th>
        <th onclick="srt('M2','annee_arrivee')">ARRIVÃ‰E â†•</th>
        <th>INSCRIPTION</th><th>PART.</th><th>VÃ‰RIF.</th><th></th>
      </tr></thead>
      <tbody id="tb2"></tbody>
    </table></div>
    <div class="pag" id="pg2"></div>
  </div>
</div>

<!-- â•â• TAB CARTE â•â• -->
<div class="tc" id="tab-carte">
  <div class="topbar"><div class="tt"><h1>Carte des membres</h1><p>RÃ©partition gÃ©ographique</p></div></div>
  <div class="card" style="margin-bottom:14px">
    <div class="mfbar">
      <div class="sw"><input type="search" id="ms" placeholder="Rechercherâ€¦" oninput="updateMap()"></div>
      <select class="flt" id="mfs" onchange="updateMap()"><option value="">Tous statuts</option><option>Professionnel</option><option>Ã‰tudiant</option><option>Autre</option></select>
      <select class="flt" id="mfd" onchange="updateMap()"><option value="">Participation</option><option value="Oui">Oui</option><option value="Non">Non</option></select>
      <select class="flt" id="mfq" onchange="updateMap()"><option value="">Tous quartiers</option></select>
    </div>
    <div class="qbar" id="qbar"></div>
    <div id="map"></div>
  </div>
</div>

<!-- â•â• TAB TÃ‚CHES â•â• -->
<div class="tc" id="tab-taches">
  <div class="topbar">
    <div class="tt"><h1>Suivi des activitÃ©s</h1><p>TÃ¢ches par commission Â· AKF 2026</p></div>
    <div class="ta">
      <button class="btn bgh" onclick="expCSV('taches')">â¬‡ï¸ CSV</button>
      <button class="btn bg" onclick="openOv('at')">ï¼‹ Ajouter</button>
    </div>
  </div>
  <div class="kpis">
    <div class="kpi" onclick="kpiT('',this)">
      <div class="kh"><div class="ki" style="background:#f0fdf4">ğŸ“‹</div><span class="kt" style="background:#f0fdf4;color:var(--gr)">Total</span></div>
      <div class="kv" style="color:var(--gr)" id="tv0">0</div><div class="kl">TÃ¢ches totales</div>
      <div class="kb"><div class="kbf" style="background:var(--gr);width:100%"></div></div>
    </div>
    <div class="kpi" onclick="kpiT('TerminÃ©e',this)">
      <div class="kh"><div class="ki" style="background:var(--gp)">âœ…</div><span class="kt" style="background:var(--gp);color:var(--gr)" id="tp1">0%</span></div>
      <div class="kv" style="color:var(--gr)" id="tv1">0</div><div class="kl">TerminÃ©es</div>
      <div class="kb"><div class="kbf" id="tb1f" style="background:var(--gr)"></div></div>
    </div>
    <div class="kpi" onclick="kpiT('En cours',this)">
      <div class="kh"><div class="ki" style="background:var(--blp)">ğŸ”„</div><span class="kt" style="background:var(--blp);color:var(--bl)" id="tp2">0%</span></div>
      <div class="kv" style="color:var(--bl)" id="tv2">0</div><div class="kl">En cours</div>
      <div class="kb"><div class="kbf" id="tb2f" style="background:var(--bl)"></div></div>
    </div>
    <div class="kpi" onclick="kpiT('Ã€ faire',this)">
      <div class="kh"><div class="ki" style="background:var(--gop)">ğŸ“Œ</div><span class="kt" style="background:var(--gop);color:var(--go)" id="tp3">0%</span></div>
      <div class="kv" style="color:var(--go)" id="tv3">0</div><div class="kl">Ã€ faire</div>
      <div class="kb"><div class="kbf" id="tb3f" style="background:var(--go)"></div></div>
    </div>
  </div>
  <div class="cr2">
    <div class="card"><div class="ct"><span class="ctl">RÃ©partition statuts</span></div><div class="cw"><canvas id="cht1"></canvas></div></div>
    <div class="card"><div class="ct"><span class="ctl">TÃ¢ches par commission</span></div><div class="cw"><canvas id="cht2"></canvas></div></div>
  </div>
  <div class="tcard">
    <div class="toolbar">
      <div class="sw"><input type="search" id="ts" placeholder="Rechercherâ€¦" oninput="applyFT()"></div>
      <select class="flt" id="tfs" onchange="applyFT()"><option value="">Tous statuts</option><option>Ã€ faire</option><option>En cours</option><option>TerminÃ©e</option><option>AnnulÃ©</option><option>Abandonner</option></select>
      <select class="flt" id="tfc" onchange="applyFT()"><option value="">Toutes commissions</option><option>PrÃ©sidence</option><option>SecrÃ©tariat</option><option>TrÃ©sorerie</option><option>Communication</option><option>Organisation</option><option>Social et Ã©ducatif</option><option>Relations extÃ©rieures</option></select>
      <select class="flt" id="tfp" onchange="applyFT()"><option value="">Toutes prioritÃ©s</option><option>Haute</option><option>Moyenne</option><option>Basse</option></select>
      <span class="rc" id="rct">0 tÃ¢ches</span>
    </div>
    <div class="tw"><table>
      <thead><tr>
        <th onclick="srt('T','activite')" class="s">ACTIVITÃ‰ â†•</th>
        <th onclick="srt('T','commission')">COMMISSION â†•</th>
        <th onclick="srt('T','responsable')">RESPONSABLE â†•</th>
        <th onclick="srt('T','date_debut')">DÃ‰BUT â†•</th>
        <th onclick="srt('T','date_fin')">Ã‰CHÃ‰ANCE â†•</th>
        <th onclick="srt('T','statut')">STATUT â†•</th>
        <th onclick="srt('T','priorite')">PRIORITÃ‰ â†•</th>
        <th>COMMENTAIRES</th><th></th>
      </tr></thead>
      <tbody id="tbt"></tbody>
    </table></div>
    <div class="pag" id="pgt"></div>
  </div>
</div>

</main>
</div>

<!-- â•â•â• MODAL AJOUT MEMBRE â•â•â• -->
<div class="ov" id="ov-am">
  <div class="mbox">
    <div class="mtit">â• Ajouter un membre <button class="mc" onclick="closeOv('am')">âœ•</button></div>
    <div class="fg">
      <div class="fr"><label>Nom *</label><input id="am-nom" placeholder="NOM"></div>
      <div class="fr"><label>PrÃ©nom *</label><input id="am-prenom" placeholder="PrÃ©nom"></div>
      <div class="fr"><label>Sexe</label><select id="am-sexe"><option>Homme</option><option>Femme</option></select></div>
      <div class="fr"><label>Ville *</label><input id="am-ville" placeholder="Paris"></div>
      <div class="fr"><label>TÃ©lÃ©phone</label><input id="am-telephone" placeholder="06â€¦"></div>
      <div class="fr"><label>Email</label><input id="am-email" type="email"></div>
      <div class="fr"><label>AnnÃ©e d'arrivÃ©e</label><input id="am-annee_arrivee" type="number" min="1990" max="2030" placeholder="2022"></div>
      <div class="fr"><label>Statut</label><select id="am-statut"><option>Professionnel</option><option>Ã‰tudiant</option><option>Autre</option></select></div>
      <div class="fr full"><label>SpÃ©cialitÃ© / Fonction</label><input id="am-specialite" placeholder="IngÃ©nieur, Comptableâ€¦"></div>
      <div class="fr"><label>Quartier d'origine</label><input id="am-quartier" placeholder="Escale, MÃ©dinaâ€¦"></div>
      <div class="fr"><label>Participation bureau</label><select id="am-direction"><option value="Oui">Oui</option><option value="Non" selected>Non</option></select></div>
      <div class="fr"><label>VÃ©rification</label><select id="am-verification"><option>VÃ©rifiÃ©</option><option>Non vÃ©rifiÃ©</option></select></div>
    </div>
    <div class="fa">
      <button class="btn bgh" onclick="closeOv('am')">Annuler</button>
      <button class="btn bg" onclick="addMembre()">âœ… Enregistrer</button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL EDITION MEMBRE â•â•â• -->
<div class="ov" id="ov-em" onclick="if(event.target===this)closeOv('em')">
  <div class="mbox">
    <div class="mtit">âœï¸ Modifier le membre <button class="mc" onclick="closeOv('em')">âœ•</button></div>
    <div class="fg">
      <div class="fr"><label>Nom *</label><input id="em-nom"></div>
      <div class="fr"><label>PrÃ©nom *</label><input id="em-prenom"></div>
      <div class="fr"><label>Sexe</label><select id="em-sexe"><option>Homme</option><option>Femme</option></select></div>
      <div class="fr"><label>Ville</label><input id="em-ville"></div>
      <div class="fr"><label>TÃ©lÃ©phone</label><input id="em-telephone"></div>
      <div class="fr"><label>Email</label><input id="em-email" type="email"></div>
      <div class="fr"><label>AnnÃ©e d'arrivÃ©e</label><input id="em-annee_arrivee" type="number" min="1990" max="2030"></div>
      <div class="fr"><label>Statut</label><select id="em-statut"><option>Professionnel</option><option>Ã‰tudiant</option><option>Autre</option></select></div>
      <div class="fr full"><label>SpÃ©cialitÃ© / Fonction</label><input id="em-specialite"></div>
      <div class="fr"><label>Quartier d'origine</label><input id="em-quartier"></div>
      <div class="fr"><label>Participation bureau</label><select id="em-direction"><option value="Oui">Oui</option><option value="Non">Non</option></select></div>
      <div class="fr"><label>VÃ©rification</label><select id="em-verification"><option>VÃ©rifiÃ©</option><option>Non vÃ©rifiÃ©</option></select></div>
    </div>
    <div class="fa">
      <button class="btn bgh" onclick="closeOv('em')">Annuler</button>
      <button class="btn bg" id="em-ok">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL AJOUT TÃ‚CHE â•â•â• -->
<div class="ov" id="ov-at">
  <div class="mbox">
    <div class="mtit">â• Ajouter une tÃ¢che <button class="mc" onclick="closeOv('at')">âœ•</button></div>
    <div class="fg">
      <div class="fr full"><label>ActivitÃ© / Projet *</label><input id="at-activite" placeholder="Nom de la tÃ¢che"></div>
      <div class="fr"><label>Commission</label>
        <select id="at-commission"><option>PrÃ©sidence</option><option>SecrÃ©tariat</option><option>TrÃ©sorerie</option><option>Communication</option><option>Organisation</option><option>Social et Ã©ducatif</option><option>Relations extÃ©rieures</option></select>
      </div>
      <div class="fr full"><label>Responsable(s)</label><input id="at-responsable" placeholder="Ex : Ibrahima et Fallouâ€¦"></div>
      <div class="fr"><label>Date dÃ©but</label><input id="at-date_debut" type="date"></div>
      <div class="fr"><label>Date fin prÃ©vue</label><input id="at-date_fin" type="date"></div>
      <div class="fr"><label>Statut</label>
        <select id="at-statut"><option>Ã€ faire</option><option>En cours</option><option>TerminÃ©e</option><option>AnnulÃ©</option><option>Abandonner</option></select>
      </div>
      <div class="fr"><label>PrioritÃ©</label>
        <select id="at-priorite"><option>Haute</option><option selected>Moyenne</option><option>Basse</option></select>
      </div>
      <div class="fr full"><label>Commentaires / Ã‰tat d'avancement</label><textarea id="at-commentaires" rows="2" placeholder="Notesâ€¦"></textarea></div>
    </div>
    <div class="fa">
      <button class="btn bgh" onclick="closeOv('at')">Annuler</button>
      <button class="btn bg" onclick="addTache()">âœ… Enregistrer</button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL EDITION TÃ‚CHE â•â•â• -->
<div class="ov" id="ov-et" onclick="if(event.target===this)closeOv('et')">
  <div class="mbox">
    <div class="mtit">âœï¸ Modifier la tÃ¢che <button class="mc" onclick="closeOv('et')">âœ•</button></div>
    <div class="fg">
      <div class="fr full"><label>ActivitÃ© / Projet *</label><input id="et-activite"></div>
      <div class="fr"><label>Commission</label>
        <select id="et-commission"><option>PrÃ©sidence</option><option>SecrÃ©tariat</option><option>TrÃ©sorerie</option><option>Communication</option><option>Organisation</option><option>Social et Ã©ducatif</option><option>Relations extÃ©rieures</option></select>
      </div>
      <div class="fr full"><label>Responsable(s)</label><input id="et-responsable"></div>
      <div class="fr"><label>Date dÃ©but</label><input id="et-date_debut" type="date"></div>
      <div class="fr"><label>Date fin prÃ©vue</label><input id="et-date_fin" type="date"></div>
      <div class="fr"><label>Statut</label>
        <select id="et-statut"><option>Ã€ faire</option><option>En cours</option><option>TerminÃ©e</option><option>AnnulÃ©</option><option>Abandonner</option></select>
      </div>
      <div class="fr"><label>PrioritÃ©</label>
        <select id="et-priorite"><option>Haute</option><option>Moyenne</option><option>Basse</option></select>
      </div>
      <div class="fr full"><label>Commentaires / Ã‰tat d'avancement</label><textarea id="et-commentaires" rows="2"></textarea></div>
    </div>
    <div class="fa">
      <button class="btn bgh" onclick="closeOv('et')">Annuler</button>
      <button class="btn bg" id="et-ok">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL DÃ‰TAIL â•â•â• -->
<div class="ov" id="ov-det" onclick="if(event.target===this)closeOv('det')">
  <div class="dbox">
    <div class="dh">
      <div class="dav" id="det-av"></div>
      <div style="flex:1">
        <div style="font-family:'DM Serif Display',serif;font-size:1.15rem" id="det-nm"></div>
        <div style="font-size:.77rem;color:var(--mu)" id="det-sub"></div>
      </div>
      <button class="mc" onclick="closeOv('det')">âœ•</button>
    </div>
    <div class="dg" id="det-grid"></div>
  </div>
</div>

<!-- â•â•â• MODAL CONFIRM SUPPRESSION â•â•â• -->
<div class="ov" id="ov-del">
  <div class="mbox sm" style="text-align:center;padding:26px">
    <div style="font-size:2rem;margin-bottom:8px">ğŸ—‘ï¸</div>
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:8px">Confirmer la suppression</div>
    <p style="font-size:.8rem;color:var(--mu);margin-bottom:18px" id="del-msg"></p>
    <div style="display:flex;gap:9px;justify-content:center">
      <button class="btn bgh" onclick="closeOv('del')">Annuler</button>
      <button class="btn br" id="del-ok">ğŸ—‘ï¸ Supprimer</button>
    </div>
  </div>
</div>

<div class="tw-wrap" id="tw-wrap"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” IDs de tes Google Sheets (lecture publique via CSV)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG = {
  membres: {
    id: '1hdCeQZQUN600ALdRLbYSqtGYl1ydrv6eutqte6aKTys',
    sheet: 'Inscrits_AKF'
  },
  taches: {
    id: '1-9Mz6T_6HdsxSOh3mRTrs2ClMwv1yblWYuy1r1y19_A',
    sheet: 'Suivi des activitÃ©s'
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONNÃ‰ES (fallback local â€” remplacÃ©es au sync)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let M = [{"nom": "BA", "prenom": "Mamadou", "sexe": "Homme", "ville": "Compiegne", "telephone": "0677753022", "email": "mamadouba7001@gmail.com", "annee_arrivee": "2019", "statut": "Professionnel", "specialite": "Remote Sensing and Geomatics", "quartier": "Diamaguene", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "06/11/2025"}, {"nom": "BA", "prenom": "Amadou", "sexe": "Homme", "ville": "Beauchamp", "telephone": "0753047505", "email": "xamete@gmail.com", "annee_arrivee": "2016", "statut": "Professionnel", "specialite": "Agent de maÃ®trise hospitalier", "quartier": "Galla", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "24/11/2025"}, {"nom": "Danfa", "prenom": "FodÃ©", "sexe": "Homme", "ville": "Le Mans", "telephone": "0651935048", "email": "danfode@gmail.com", "annee_arrivee": "2015", "statut": "Professionnel", "specialite": "Analyste de RÃ©sultats SantÃ©/ PrÃ©voyance", "quartier": "Escale", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "25/11/2025"}, {"nom": "Dia", "prenom": "Serigne saliou", "sexe": "Homme", "ville": "Le Blanc Mesnil", "telephone": "0780772233", "email": "bayssaliu@gmail.com", "annee_arrivee": "2023", "statut": "Ã‰tudiant", "specialite": "MathÃ©matiques", "quartier": "Mbabou", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "14/12/2025"}, {"nom": "Dieng", "prenom": "Ibrahima", "sexe": "Homme", "ville": "Beauchamp", "telephone": "0758462840", "email": "ibrahimadieng370@gmail.com", "annee_arrivee": "2024", "statut": "Professionnel", "specialite": "Transport logistique", "quartier": "DIAMAGUENE", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "07/12/2025"}, {"nom": "DIENG", "prenom": "Alimatou", "sexe": "Femme", "ville": "Arras", "telephone": "0609135336", "email": "alimajeng95@gmail.com", "annee_arrivee": "2023", "statut": "Professionnel", "specialite": "Comptable", "quartier": "Medina", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "17/11/2025"}, {"nom": "DIENG", "prenom": "Tabara", "sexe": "Femme", "ville": "Beauvais", "telephone": "0761465807", "email": "tabou1619@gmail.com", "annee_arrivee": "2019", "statut": "Professionnel", "specialite": "Eau et Assainissement", "quartier": "Escale", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "23/11/2025"}, {"nom": "DIENG", "prenom": "Papa", "sexe": "Homme", "ville": "Strasbourg", "telephone": "0745059018", "email": "papadieng@hotmail.fr", "annee_arrivee": "2019", "statut": "Professionnel", "specialite": "Juriste", "quartier": "Medina", "direction": "Non", "verification": "Non vÃ©rifiÃ©", "date_inscription": "25/11/2025"}, {"nom": "Diop", "prenom": "Serigne Saliou", "sexe": "Homme", "ville": "Vitry Sur Seine", "telephone": "0749363694", "email": "ssdiop2022@gmail.com", "annee_arrivee": "2022", "statut": "Ã‰tudiant", "specialite": "Logistique transport", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "14/12/2025"}, {"nom": "DIOP", "prenom": "Babacar", "sexe": "Homme", "ville": "Courbevoie", "telephone": "0783170963", "email": "bdiop8050@gmail.com", "annee_arrivee": "2018", "statut": "Professionnel", "specialite": "Management des entreprises et commerce international", "quartier": "Ndakhar Syll", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "24/11/2025"}, {"nom": "DIOP", "prenom": "Babacar", "sexe": "Homme", "ville": "Biot", "telephone": "0660023202", "email": "bdiop68@gmail.com", "annee_arrivee": "2017", "statut": "Professionnel", "specialite": "DÃ©veloppeur", "quartier": "Galla", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "24/11/2025"}, {"nom": "DIOP", "prenom": "Aliou", "sexe": "Homme", "ville": "Montpellier", "telephone": "0754197379", "email": "aliounediop2019@hotmail.com", "annee_arrivee": "2017", "statut": "Professionnel", "specialite": "Demande d'asile", "quartier": "Darou Salam", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "01/12/2025"}, {"nom": "DIOP", "prenom": "Mame Tening", "sexe": "Femme", "ville": "Rambouillet", "telephone": "0765270490", "email": "mameteningdiop@gmail.com", "annee_arrivee": "2021", "statut": "Professionnel", "specialite": "Manager", "quartier": "Medina", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "07/12/2025"}, {"nom": "DIOP", "prenom": "Ibrahima", "sexe": "Homme", "ville": "Arpajon", "telephone": "768729107", "email": "diop035@gmail.com", "annee_arrivee": "2018", "statut": "Professionnel", "specialite": "IngÃ©nieur en Informatique", "quartier": "MÃ©dina", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "25/01/2026"}, {"nom": "DIOP", "prenom": "Mor", "sexe": "Homme", "ville": "Poissy", "telephone": "0783296232", "email": "mordiop177@gmail.com", "annee_arrivee": "2014", "statut": "Professionnel", "specialite": "IngÃ©nieur GÃ©nie Ã‰lectrique", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "06/11/2025"}, {"nom": "DIOP", "prenom": "Elhadj", "sexe": "Homme", "ville": "Arras", "telephone": "0611293553", "email": "emdiop10@gmail.com", "annee_arrivee": "2010", "statut": "Professionnel", "specialite": "MÃ©tallurgie", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "08/11/2025"}, {"nom": "FALL", "prenom": "Mbaye Ababacar", "sexe": "Homme", "ville": "La Ville Du Bois", "telephone": "0767823442", "email": "ababacarmbayefall92@gmail.com", "annee_arrivee": "2021", "statut": "Professionnel", "specialite": "GÃ©ographie-AmÃ©nagement", "quartier": "Diamagueune", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "25/11/2025"}, {"nom": "FAYE", "prenom": "ELHADJI CISSE", "sexe": "Homme", "ville": "Orleans", "telephone": "0773040034", "email": "cissefaye@hotmail.fr", "annee_arrivee": "2020", "statut": "Professionnel", "specialite": "Data science / statistiques", "quartier": "Galla", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "26/11/2025"}, {"nom": "GUEYE", "prenom": "Issa", "sexe": "Homme", "ville": "Brunoy", "telephone": "0667162187", "email": "gueyeissa@gmail.com", "annee_arrivee": "2007", "statut": "Professionnel", "specialite": "Professeur en GÃ©nie mÃ©canique", "quartier": "Mbabou", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "16/11/2025"}, {"nom": "GUEYE", "prenom": "Fallou", "sexe": "Homme", "ville": "Marseille", "telephone": "0753651038", "email": "fallougueye19@hotmail.fr", "annee_arrivee": "2014", "statut": "Professionnel", "specialite": "Banquier", "quartier": "Medina", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "30/11/2025"}, {"nom": "Guisse", "prenom": "Sokhna diarra", "sexe": "Femme", "ville": "Lille", "telephone": "0767022002", "email": "guissediarra96@gmail.com", "annee_arrivee": "2017", "statut": "Professionnel", "specialite": "Data analyst", "quartier": "Medina", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "30/11/2025"}, {"nom": "Hane", "prenom": "Modou", "sexe": "Homme", "ville": "La Rochelle", "telephone": "0652399158", "email": "modouhane1997@gmail.com", "annee_arrivee": "2021", "statut": "Ã‰tudiant", "specialite": "Agroalimentaire", "quartier": "Diamagueune", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "13/12/2025"}, {"nom": "KEBE", "prenom": "Mamadou Sarr", "sexe": "Homme", "ville": "Marseille", "telephone": "0605830470", "email": "sarrkebe5@gmail.com", "annee_arrivee": "2015", "statut": "Professionnel", "specialite": "Directeur adjoint sociÃ©tÃ© SÃ©curitÃ© privÃ©e", "quartier": "Mbabou", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "09/11/2025"}, {"nom": "KEBE", "prenom": "Mohamed", "sexe": "Homme", "ville": "Livry-Gargan", "telephone": "0781467450", "email": "mohamedkebe54@gmail.com", "annee_arrivee": "2014", "statut": "Professionnel", "specialite": "IngÃ©nierie Ã©lectrique", "quartier": "MÃ©dina", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "23/11/2025"}, {"nom": "KEBE", "prenom": "Mbayang", "sexe": "Femme", "ville": "Paris", "telephone": "0752213100", "email": "mbayangkebe94@gmail.com", "annee_arrivee": "2018", "statut": "Autre", "specialite": "DÃ©veloppement informatique / chefferie de projet", "quartier": "Mbabou", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "24/11/2025"}, {"nom": "KEBE", "prenom": "Papa Amadou khoury", "sexe": "Homme", "ville": "Massy", "telephone": "0751925556", "email": "kebepapaamadou@gmail.com", "annee_arrivee": "2018", "statut": "Professionnel", "specialite": "Supply Chain / Demand & Supply Planner", "quartier": "MÃ©dina", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "24/11/2025"}, {"nom": "KEBE", "prenom": "Fatou", "sexe": "Femme", "ville": "Fampoux", "telephone": "0629613165", "email": "fatoumbackekebe@gmail.com", "annee_arrivee": "2017", "statut": "Professionnel", "specialite": "Ingenieur logiciel", "quartier": "Medina", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "01/12/2025"}, {"nom": "KEBE", "prenom": "Alassane", "sexe": "Homme", "ville": "Meaux", "telephone": "0604553750", "email": "akebe2929@gmail.com", "annee_arrivee": "2023", "statut": "Professionnel", "specialite": "IngÃ©nieur gÃ©nie civil", "quartier": "Escale", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "08/12/2025"}, {"nom": "KHOUMA", "prenom": "Bamba", "sexe": "Homme", "ville": "Vitry Sur Seine", "telephone": "0659287928", "email": "bambasougoukhouma@gmail.com", "annee_arrivee": "2019", "statut": "Professionnel", "specialite": "Agent MaÃ®trise", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "24/11/2025"}, {"nom": "MBENGUE", "prenom": "Mouhamadou", "sexe": "Homme", "ville": "Le Blanc Mesnil", "telephone": "0624796900", "email": "modou813@gmail.com", "annee_arrivee": "2018", "statut": "Professionnel", "specialite": "Statisticien-Econometre", "quartier": "Galla", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "07/12/2025"}, {"nom": "NDIAYE", "prenom": "Saliou", "sexe": "Homme", "ville": "Strasbourg", "telephone": "0637743612", "email": "saliounafy@gmail.com", "annee_arrivee": "2013", "statut": "Professionnel", "specialite": "Responsable commercial", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "16/11/2025"}, {"nom": "NIANG", "prenom": "Saye", "sexe": "Femme", "ville": "Nancy", "telephone": "0758258967", "email": "saye.niang023@gmail.com", "annee_arrivee": "2019", "statut": "Professionnel", "specialite": "Doctorante en chimie", "quartier": "Galla", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "08/11/2025"}, {"nom": "SECK", "prenom": "Antou", "sexe": "Homme", "ville": "Gif Sur Yvette", "telephone": "0783070274", "email": "antouthiateseck@gmail.com", "annee_arrivee": "2019", "statut": "Professionnel", "specialite": "Agent ferroviaire", "quartier": "Medina", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "09/11/2025"}, {"nom": "SECK", "prenom": "Dame", "sexe": "Homme", "ville": "Cachan", "telephone": "0783878430", "email": "seck-dame@hotmail.fr", "annee_arrivee": "2014", "statut": "Professionnel", "specialite": "Data engineer", "quartier": "MÃ©dina", "direction": "Non", "verification": "VÃ©rifiÃ©", "date_inscription": "26/11/2025"}, {"nom": "SYLL", "prenom": "Ndeye Fatou", "sexe": "Femme", "ville": "Marseille", "telephone": "0766264462", "email": "ndeyefatousyll122@gmail.com", "annee_arrivee": "2021", "statut": "Ã‰tudiant", "specialite": "GÃ©nie Ã©lectrique", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "01/12/2025"}, {"nom": "SYLL", "prenom": "Ibrahima", "sexe": "Homme", "ville": "Arras", "telephone": "0638542701", "email": "syll.ibrahima@gmail.com", "annee_arrivee": "2011", "statut": "Professionnel", "specialite": "Juriste marchÃ©s publics", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "06/11/2025"}, {"nom": "SYLL", "prenom": "Fallou", "sexe": "Homme", "ville": "Neuilly Sur Marne", "telephone": "0751215130", "email": "fallousyll24@gmail.com", "annee_arrivee": "2020", "statut": "Professionnel", "specialite": "Comptable", "quartier": "Escale", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "24/11/2025"}, {"nom": "THIAM", "prenom": "Massamba", "sexe": "Homme", "ville": "Paris", "telephone": "0650778846", "email": "massambathiam1992@gmail.com", "annee_arrivee": "2016", "statut": "Professionnel", "specialite": "Informatique", "quartier": "Diamaguene", "direction": "Oui", "verification": "VÃ©rifiÃ©", "date_inscription": "25/11/2025"}];
let T = [{"id": "1301202600001", "activite": "Tableau de bord de suivi des activitÃ©s", "commission": "SecrÃ©tariat", "responsable": "Ibrahima et Mamadou", "date_debut": "13/01/2026", "date_fin": "17/01/2026", "statut": "TerminÃ©e", "relance": "", "priorite": "Moyenne", "commentaires": "A voir avec bureau"}, {"id": "1301202600002", "activite": "PrÃ©paration des documents officiels (RRI, Statuts)", "commission": "SecrÃ©tariat", "responsable": "Ibrahima, Pape Dieng et Mamadou", "date_debut": "13/01/2026", "date_fin": "17/01/2026", "statut": "TerminÃ©e", "relance": "", "priorite": "Haute", "commentaires": "Documents en relecture par Ibou et Pape Dieng"}, {"id": "1301202600003", "activite": "Faire un rappel de cotisations dans le groupe WhatsApp", "commission": "TrÃ©sorerie", "responsable": "Fallou et Issa", "date_debut": "13/01/2026", "date_fin": "17/01/2026", "statut": "TerminÃ©e", "relance": "", "priorite": "Moyenne", "commentaires": "Relance Ã  faire le 14/01"}, {"id": "1301202600004", "activite": "Envoyer convocation officielle AG", "commission": "SecrÃ©tariat", "responsable": "Ibrahima et Mamadou", "date_debut": "18/01/2026", "date_fin": "20/01/2026", "statut": "TerminÃ©e", "relance": "", "priorite": "Moyenne", "commentaires": ""}, {"id": "1301202600005", "activite": "Faire le sondage pour la date de l'AG", "commission": "SecrÃ©tariat", "responsable": "Ibrahima et Mamadou", "date_debut": "14/01/2026", "date_fin": "15/01/2026", "statut": "TerminÃ©e", "relance": "", "priorite": "Haute", "commentaires": "Mettre un sondage dans le groupe whatsApp afin de determiner la date de l'AG (21 ou 25 janvier)"}, {"id": "1301202600006", "activite": "Rappel des attendues de la reunion du 1er mars", "commission": "PrÃ©sidence", "responsable": "Mor et Saye", "date_debut": "17/02/2026", "date_fin": "22/02/2026", "statut": "En cours", "relance": "", "priorite": "Haute", "commentaires": ""}];

const GEO = {"Compiegne": [49.4134, 2.8235], "Beauchamp": [49.0147, 2.1947], "Le Mans": [48.0061, 0.1996], "Le Blanc Mesnil": [48.9378, 2.4628], "Arras": [50.2919, 2.781], "Beauvais": [49.4295, 2.0825], "Strasbourg": [48.5734, 7.7521], "Courbevoie": [48.8975, 2.2535], "Biot": [43.6261, 7.0967], "Montpellier": [43.6117, 3.8777], "Rambouillet": [48.6454, 1.8305], "Vitry Sur Seine": [48.7876, 2.3928], "Arpajon": [48.5906, 2.2453], "Poissy": [48.9297, 2.0467], "La Ville Du Bois": [48.6483, 2.2758], "Orleans": [47.9029, 1.9092], "Brunoy": [48.6969, 2.4942], "Marseille": [43.2965, 5.3698], "Lille": [50.6292, 3.0573], "La Rochelle": [46.1603, -1.1511], "Livry-Gargan": [48.9175, 2.5333], "Paris": [48.8566, 2.3522], "Massy": [48.7257, 2.2725], "Fampoux": [50.3167, 2.8667], "Meaux": [48.9607, 2.8878], "Nancy": [48.6921, 6.1844], "Gif Sur Yvette": [48.6833, 2.1333], "Cachan": [48.7942, 2.3333], "Neuilly Sur Marne": [48.8556, 2.5522]};
function gc(v){if(!v)return null;const k=v.trim();if(GEO[k])return GEO[k];const l=k.toLowerCase();for(const[n,c]of Object.entries(GEO)){if(n.toLowerCase().includes(l)||l.includes(n.toLowerCase()))return c;}return null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC DEPUIS GOOGLE SHEETS (lecture CSV public â€” aucun script requis)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function csvURL(id, sheet){
  return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;
}

function parseCSV(txt){
  const lines = txt.trim().split('\n');
  if(lines.length < 2) return [];
  const headers = splitCSVLine(lines[0]);
  return lines.slice(1).map(l => {
    const vals = splitCSVLine(l);
    const obj = {};
    headers.forEach((h,i) => obj[h] = (vals[i]||'').trim());
    return obj;
  }).filter(r => Object.values(r).some(v => v));
}

function splitCSVLine(line){
  const res = []; let cur = '', inQ = false;
  for(let i=0;i<line.length;i++){
    const c = line[i];
    if(c==='"'){inQ=!inQ;}
    else if(c===','&&!inQ){res.push(cur);cur='';}
    else cur+=c;
  }
  res.push(cur);
  return res;
}

function mapMembre(r){
  // Colonnes: Nom, PrÃ©nom, Sexe, Ville, TÃ©lÃ©phone, E-mail,
  //           AnnÃ©e d'arrivÃ©e, Statut, SpÃ©cialitÃ©, PrÃ©sentation,
  //           Quartier, Direction, Code, Statut, Date inscription
  return {
    nom:           r['Nom']||'',
    prenom:        r['PrÃ©nom']||'',
    sexe:          r['Sexe']||'Homme',
    ville:         r['Ville']||'',
    telephone:     r['TÃ©lÃ©phone']||'',
    email:         r['E-mail']||r['Email']||'',
    annee_arrivee: r["AnnÃ©e d'arrivÃ©e"]||'',
    statut:        r['Statut']||'Autre',
    specialite:    r['SpÃ©cialitÃ©']||'',
    presentation:  r['PrÃ©sentation']||'',
    quartier:      r['Quartier']||'',
    direction:     r['Direction']||'Non',
    verification:  r['VÃ©rification']||r['Code']||'Non vÃ©rifiÃ©',
    date_inscription: r['Date inscription']||'',
  };
}

function mapTache(r){
  // Colonnes: ID ActivitÃ©, ActivitÃ© / Projet, Commission, Responsable,
  //           Date dÃ©but, Date fin prÃ©vue, Statut, Relance, PrioritÃ©,
  //           Commentaires / Ã‰tat d'avancement
  function fmtDate(v){
    if(!v)return '';
    // Si format Date Google (ex: 1/13/2026 â†’ dd/mm/yyyy)
    const d = new Date(v);
    if(!isNaN(d)) return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    return v;
  }
  return {
    id:           r['ID ActivitÃ©']||'',
    activite:     r['ActivitÃ© / Projet']||'',
    commission:   r['Commission']||'',
    responsable:  r['Responsable']||'',
    date_debut:   fmtDate(r['Date dÃ©but']),
    date_fin:     fmtDate(r['Date fin prÃ©vue']),
    statut:       r['Statut']||'Ã€ faire',
    relance:      r['Relance']||'',
    priorite:     r['PrioritÃ©']||'Moyenne',
    commentaires: r["Commentaires / Ã‰tat d'avancement"]||'',
  };
}

async function syncData(){
  const btn = g('sync-btn');
  btn.disabled = true; btn.textContent = 'â³ Synchronisationâ€¦';
  g('ldov').classList.remove('hide');
  g('ldtxt').textContent = 'Chargement depuis Google Sheetsâ€¦';

  let okM = false, okT = false;
  try {
    const respM = await fetch(csvURL(CFG.membres.id, CFG.membres.sheet));
    if(respM.ok){
      const raw = parseCSV(await respM.text());
      const mapped = raw.map(mapMembre).filter(m => m.nom);
      if(mapped.length){ M = mapped; okM = true; }
    }
  } catch(e){ console.warn('Membres sync error:', e); }

  try {
    const respT = await fetch(csvURL(CFG.taches.id, CFG.taches.sheet));
    if(respT.ok){
      const raw = parseCSV(await respT.text());
      const mapped = raw.map(mapTache).filter(t => t.activite);
      if(mapped.length){ T = mapped; okT = true; }
    }
  } catch(e){ console.warn('TÃ¢ches sync error:', e); }

  g('ldov').classList.add('hide');
  btn.disabled = false;

  if(okM || okT){
    btn.textContent = 'âœ… SynchronisÃ©';
    toast(`âœ… ${okM ? M.length+' membres' : ''} ${okM&&okT?'Â·':''} ${okT ? T.length+' tÃ¢ches' : ''} chargÃ©s`, '#0e7a45');
    g('sfoot').textContent = 'Sync Google Sheets Â· ' + new Date().toLocaleTimeString('fr-FR');
  } else {
    btn.textContent = 'âš ï¸ Ã‰chec (donnÃ©es locales)';
    toast('âš ï¸ Google Sheets inaccessible â€” donnÃ©es locales utilisÃ©es', '#b07d0a');
  }
  setTimeout(() => { btn.textContent = 'ğŸ”„ Synchroniser Sheets'; }, 4000);

  refreshAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TAT & UTILITAIRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fM=[], fM2=[], fT=[];
let scM='nom', sdM=1, scM2='nom', sdM2=1, scT='activite', sdT=1;
let p1=1, p2=1, pt=1;
const PS = 12;
let akM='', akT='';
let mapI=null, mCluster=null;
let chM1=null, chM2=null, chT1=null, chT2=null;
let delFn=null, emiIdx=-1, etiIdx=-1;

const COLORS=['#0e7a45','#1c5fad','#b07d0a','#8b44ac','#c0392b','#16a85f','#e67e22','#2980b9'];
function ac(n){let h=0;for(const c of(n||''))h=(h*31+c.charCodeAt(0))%COLORS.length;return COLORS[h];}
function ini(n,p){return((n||'')[0]||'?').toUpperCase()+((p||'')[0]||'?').toUpperCase();}
function g(id){return document.getElementById(id);}
function hl(s,q){if(!q||!s)return s||'';const i=s.toLowerCase().indexOf(q);return i<0?s:s.slice(0,i)+'<mark style="background:#fef08a;border-radius:2px">'+s.slice(i,i+q.length)+'</mark>'+s.slice(i+q.length);}
function pct(n,t){return t?Math.round(n/t*100)+'%':'0%';}
function isLate(t){if(!t.date_fin||['TerminÃ©e','AnnulÃ©'].includes(t.statut))return false;const[d,m,y]=t.date_fin.split('/');return new Date(y,m-1,d)<new Date();}
function toISO(d){if(!d)return'';const p=d.split('/');return p.length===3?`${p[2]}-${p[1]}-${p[0]}`:''}
function toFR(d){if(!d)return'';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:''}
function nowFR(){const d=new Date();return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;}
function genId(){const n=new Date();return String(n.getDate()).padStart(2,'0')+String(n.getMonth()+1).padStart(2,'0')+n.getFullYear()+String(T.length+1).padStart(5,'0');}

function toast(msg, bg='#0f1923'){
  const el=document.createElement('div');
  el.className='toast'; el.style.background=bg; el.textContent=msg;
  g('tw-wrap').appendChild(el); setTimeout(()=>el.remove(),3500);
}
function openOv(id){g('ov-'+id).classList.add('open');}
function closeOv(id){g('ov-'+id).classList.remove('open');}
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.ov.open').forEach(o=>o.classList.remove('open'));});

const CMAP = {
  'PrÃ©sidence':         {col:'#7c3aed', bg:'#f3effe', ico:'ğŸ‘‘'},
  'SecrÃ©tariat':        {col:'#1c5fad', bg:'#e8f0fc', ico:'ğŸ“'},
  'TrÃ©sorerie':         {col:'#b07d0a', bg:'#fdf4dd', ico:'ğŸ’°'},
  'Communication':      {col:'#c0392b', bg:'#fdf0ee', ico:'ğŸ“¢'},
  'Organisation':       {col:'#0e7a45', bg:'#e8f5ee', ico:'âš™ï¸'},
  'Social et Ã©ducatif': {col:'#0891b2', bg:'#e0f7fa', ico:'ğŸ¤'},
  'Relations extÃ©rieures':{col:'#be5504',bg:'#fff3e0',ico:'ğŸŒ'}
};
const SCOL={'Ã€ faire':'#b07d0a','En cours':'#1c5fad','TerminÃ©e':'#0e7a45','AnnulÃ©':'#c0392b','Abandonner':'#6b7d8f'};
const SBG= {'Ã€ faire':'#fdf4dd','En cours':'#e8f0fc','TerminÃ©e':'#e8f5ee','AnnulÃ©':'#fdf0ee','Abandonner':'#f0f4f8'};
const PCOL={'Haute':'#c0392b','Moyenne':'#b07d0a','Basse':'#0e7a45'};
const PBG= {'Haute':'#fdf0ee','Moyenne':'#fdf4dd','Basse':'#e8f5ee'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(id, el){
  document.querySelectorAll('.tc').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('on'));
  g('tab-'+id).classList.add('on'); el.classList.add('on');
  if(id==='carte') setTimeout(()=>mapI&&mapI.invalidateSize(),220);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPIs MEMBRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKM(){
  const tot=M.length;
  const pro=M.filter(r=>r.statut==='Professionnel').length;
  const etu=M.filter(r=>r.statut==='Ã‰tudiant').length;
  const aut=tot-pro-etu;
  g('kv0').textContent=tot; g('kv1').textContent=pro; g('kv2').textContent=etu; g('kv3').textContent=aut;
  g('kp1').textContent=pct(pro,tot); g('kp2').textContent=pct(etu,tot); g('kp3').textContent=pct(aut,tot);
  g('kb1').style.width=pct(pro,tot); g('kb2').style.width=pct(etu,tot); g('kb3').style.width=pct(aut,tot);
  g('nb-m').textContent=tot; g('nb-l').textContent=tot;
}
function kpiM(s,el){
  akM = (akM===s) ? '' : s;
  document.querySelectorAll('#tab-membres .kpi').forEach(k=>k.classList.remove('on'));
  if(akM) el.classList.add('on');
  applyFM();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS MEMBRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawChM(){
  const f1=g('cf1').value, f2=g('cf2').value;
  const sub1 = f1 ? M.filter(r=>r.statut===f1) : M;
  const sub2 = f2 ? M.filter(r=>r.statut===f2) : M;
  // donut statuts
  const sc={Professionnel:0,Ã‰tudiant:0,Autre:0};
  sub1.forEach(r=>{const k=sc[r.statut]!==undefined?r.statut:'Autre'; sc[k]++;});
  if(chM1)chM1.destroy();
  chM1=new Chart(g('ch1'),{type:'doughnut',data:{labels:Object.keys(sc),datasets:[{data:Object.values(sc),backgroundColor:['#1c5fad','#b07d0a','#374151'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:10,font:{size:11,family:'DM Sans'}}}}}});
  // bar annÃ©es
  const yc={};
  sub2.forEach(r=>{if(r.annee_arrivee)yc[r.annee_arrivee]=(yc[r.annee_arrivee]||0)+1;});
  const yk=Object.keys(yc).sort();
  if(chM2)chM2.destroy();
  chM2=new Chart(g('ch2'),{type:'bar',data:{labels:yk,datasets:[{data:yk.map(k=>yc[k]),backgroundColor:'#0e7a45',borderRadius:5,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1,font:{family:'DM Sans',size:10}}},x:{ticks:{font:{family:'DM Sans',size:9}},grid:{display:false}}}}});
  // top villes
  const vc={};M.forEach(r=>{if(r.ville)vc[r.ville]=(vc[r.ville]||0)+1;});
  const vs=Object.entries(vc).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const mx=vs[0]?vs[0][1]:1;
  g('tvilles').innerHTML=vs.map(([v,n])=>`<div style="display:flex;align-items:center;gap:8px;padding:5px 12px;border-bottom:1px solid var(--ln)"><span style="font-size:.75rem;flex:1">${v}</span><div style="height:6px;background:var(--gr);border-radius:3px;width:${Math.round(n/mx*80)}px"></div><span style="font-size:.72rem;font-weight:700;color:var(--gr);min-width:18px;text-align:right">${n}</span></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTRES MEMBRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSelects(){
  const vs=[...new Set(M.map(r=>r.ville).filter(Boolean))].sort();
  const as=[...new Set(M.map(r=>r.annee_arrivee).filter(Boolean))].sort();
  const qs=[...new Set(M.map(r=>r.quartier).filter(Boolean))].sort();
  ['f1v','f2v'].forEach(id=>{const s=g(id);s.innerHTML='<option value="">Toutes villes</option>';vs.forEach(v=>s.innerHTML+=`<option>${v}</option>`);});
  ['f1a','f2a'].forEach(id=>{const s=g(id);s.innerHTML='<option value="">Toutes annÃ©es</option>';as.forEach(a=>s.innerHTML+=`<option>${a}</option>`);});
  ['f2q','mfq'].forEach(id=>{const s=g(id);s.innerHTML='<option value="">Tous quartiers</option>';qs.forEach(q=>s.innerHTML+=`<option>${q}</option>`);});
}

function applyFM(){
  const q=g('s1').value.toLowerCase().trim();
  const es=akM||g('f1s').value, ed=g('f1d').value, ex=g('f1x').value, ev=g('f1v').value, ea=g('f1a').value;
  fM=M.filter(r=>{
    if(q&&![r.nom,r.prenom,r.ville,r.specialite,r.quartier].join(' ').toLowerCase().includes(q))return false;
    if(es&&r.statut!==es)return false;
    if(ed&&r.direction!==ed)return false;
    if(ex&&r.sexe!==ex)return false;
    if(ev&&r.ville!==ev)return false;
    if(ea&&r.annee_arrivee!==ea)return false;
    return true;
  });
  fM.sort((a,b)=>String(a[scM]).localeCompare(String(b[scM]),'fr',{numeric:true})*sdM);
  p1=1; g('rc1').textContent=fM.length+' membre'+(fM.length>1?'s':'');
  renderT1();
}

function applyFM2(){
  const q=g('s2').value.toLowerCase().trim();
  const es=g('f2s').value, ev=g('f2v').value, eq=g('f2q').value, ed=g('f2d').value, ea=g('f2a').value;
  fM2=M.filter(r=>{
    if(q&&![r.nom,r.prenom,r.ville,r.specialite,r.quartier,r.email].join(' ').toLowerCase().includes(q))return false;
    if(es&&r.statut!==es)return false;
    if(ev&&r.ville!==ev)return false;
    if(eq&&r.quartier!==eq)return false;
    if(ed&&r.direction!==ed)return false;
    if(ea&&r.annee_arrivee!==ea)return false;
    return true;
  });
  fM2.sort((a,b)=>String(a[scM2]).localeCompare(String(b[scM2]),'fr',{numeric:true})*sdM2);
  p2=1; g('rc2').textContent=fM2.length+' membre'+(fM2.length>1?'s':'');
  renderT2();
}

function srt(type, col){
  if(type==='M'){scM===col?sdM*=-1:(scM=col,sdM=1);applyFM();}
  else if(type==='M2'){scM2===col?sdM2*=-1:(scM2=col,sdM2=1);applyFM2();}
  else{scT===col?sdT*=-1:(scT=col,sdT=1);applyFT();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TABLEAU 1 (dashboard membres)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderT1(){
  const rows=fM.slice((p1-1)*PS,p1*PS), q=g('s1').value.toLowerCase().trim();
  g('tb1').innerHTML = rows.length ? rows.map(r=>{
    const idx=M.indexOf(r), c=ac(r.nom);
    const pillStatut = r.statut==='Professionnel' ? `style="background:var(--blp);color:var(--bl)"` : r.statut==='Ã‰tudiant' ? `style="background:var(--gop);color:var(--go)"` : `style="background:#f3f4f6;color:#374151"`;
    const pillDir = r.direction==='Oui' ? `style="background:var(--gp);color:var(--gr)"` : `style="background:#f3f4f6;color:#6b7280"`;
    const pillVerif = r.verification==='VÃ©rifiÃ©' ? `style="background:var(--gp);color:var(--gr)"` : `style="background:var(--rep);color:var(--re)"`;
    return `<tr>
      <td style="cursor:pointer" onclick="showDM(${idx})">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="av" style="background:${c}">${ini(r.nom,r.prenom)}</div>
          <div>
            <div class="tn">${hl((r.nom||'').toUpperCase(),q)} ${hl(r.prenom,q)}</div>
            <div class="tsub">${r.sexe}</div>
          </div>
        </div>
      </td>
      <td style="cursor:pointer" onclick="showDM(${idx})">${hl(r.ville,q)}</td>
      <td style="cursor:pointer" onclick="showDM(${idx})">
        <div style="font-size:.76rem">${r.telephone}</div>
        <div class="tsub" style="font-size:.68rem">${r.email}</div>
      </td>
      <td><span class="pill" ${pillStatut}>${r.statut==='Professionnel'?'ğŸ’¼':r.statut==='Ã‰tudiant'?'ğŸ“':'ğŸ”¹'} ${r.statut}</span></td>
      <td style="max-width:155px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.77rem" title="${r.specialite||''}">${hl(r.specialite||'â€”',q)}</td>
      <td style="font-weight:600">${r.annee_arrivee||'â€”'}</td>
      <td><span class="pill" ${pillDir}>${r.direction==='Oui'?'âœ‹ ':''}${r.direction}</span></td>
      <td><span class="pill" ${pillVerif}>${r.verification==='VÃ©rifiÃ©'?'âœ…':'âš ï¸'} ${r.verification}</span></td>
      <td>
        <div style="display:flex;gap:5px">
          <button class="btn bgh bsm" onclick="editMembre(${idx})" title="Modifier">âœï¸</button>
          <button class="btn br bsm" onclick="confirmDel('membre',${idx})" title="Supprimer">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--mu)">Aucun rÃ©sultat</td></tr>`;
  renderPag('pg1',fM.length,p1,v=>{p1=v;renderT1();});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TABLEAU 2 (liste complÃ¨te)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderT2(){
  const rows=fM2.slice((p2-1)*PS,p2*PS), q=g('s2').value.toLowerCase().trim();
  g('tb2').innerHTML = rows.length ? rows.map(r=>{
    const idx=M.indexOf(r), c=ac(r.nom);
    const pillStatut = r.statut==='Professionnel' ? `style="background:var(--blp);color:var(--bl)"` : r.statut==='Ã‰tudiant' ? `style="background:var(--gop);color:var(--go)"` : `style="background:#f3f4f6;color:#374151"`;
    const pillDir = r.direction==='Oui' ? `style="background:var(--gp);color:var(--gr)"` : `style="background:#f3f4f6;color:#6b7280"`;
    const pillVerif = r.verification==='VÃ©rifiÃ©' ? `style="background:var(--gp);color:var(--gr)"` : `style="background:var(--rep);color:var(--re)"`;
    return `<tr>
      <td>
        <div style="display:flex;align-items:center;gap:7px">
          <div class="av" style="background:${c}">${ini(r.nom,r.prenom)}</div>
          <div class="tn">${hl((r.nom||'').toUpperCase(),q)} ${hl(r.prenom,q)}</div>
        </div>
      </td>
      <td>${hl(r.ville,q)}</td>
      <td style="font-size:.75rem">${r.telephone}</td>
      <td style="font-size:.72rem;color:var(--mu)">${r.email}</td>
      <td><span class="pill" ${pillStatut}>${r.statut}</span></td>
      <td style="max-width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${hl(r.specialite||'â€”',q)}</td>
      <td>${r.quartier||'â€”'}</td>
      <td style="font-weight:600">${r.annee_arrivee||'â€”'}</td>
      <td>${r.date_inscription||'â€”'}</td>
      <td><span class="pill" ${pillDir}>${r.direction}</span></td>
      <td><span class="pill" ${pillVerif}>${r.verification==='VÃ©rifiÃ©'?'âœ…':'âš ï¸'}</span></td>
      <td>
        <div style="display:flex;gap:5px">
          <button class="btn bgh bsm" onclick="editMembre(${idx})" title="Modifier">âœï¸</button>
          <button class="btn br bsm" onclick="confirmDel('membre',${idx})" title="Supprimer">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="12" style="text-align:center;padding:24px;color:var(--mu)">Aucun rÃ©sultat</td></tr>`;
  renderPag('pg2',fM2.length,p2,v=>{p2=v;renderT2();});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TABLEAU TÃ‚CHES â€” style identique membres
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTT(){
  const rows=fT.slice((pt-1)*PS,pt*PS), q=g('ts').value.toLowerCase().trim();
  g('tbt').innerHTML = rows.length ? rows.map(t=>{
    const idx=T.indexOf(t);
    const cm=CMAP[t.commission]||{col:'#6b7d8f',bg:'#f0f4f8',ico:'ğŸ“‹'};
    const sc=SCOL[t.statut]||'#6b7d8f', sb=SBG[t.statut]||'#f0f4f8';
    const pc=PCOL[t.priorite]||'#b07d0a', pb=PBG[t.priorite]||'#fdf4dd';
    return `<tr>
      <td style="min-width:210px;cursor:pointer" onclick="showDT(${idx})">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="av" style="background:${cm.col};font-size:1rem;min-width:34px">${cm.ico}</div>
          <div style="min-width:0">
            <div class="tn" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px" title="${t.activite}">${hl(t.activite,q)}</div>
            <div class="tsub">${t.id}</div>
          </div>
        </div>
      </td>
      <td><span class="pill" style="background:${cm.bg};color:${cm.col};font-size:.66rem">${cm.ico} ${hl(t.commission||'â€”',q)}</span></td>
      <td style="font-size:.77rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.responsable||''}">${hl(t.responsable||'â€”',q)}</td>
      <td style="font-size:.76rem;white-space:nowrap">${t.date_debut||'â€”'}</td>
      <td style="font-size:.76rem;white-space:nowrap;${isLate(t)?'color:var(--re);font-weight:700':''}">${t.date_fin||'â€”'}${isLate(t)?' âš ï¸':''}</td>
      <td><span class="pill" style="background:${sb};color:${sc};font-size:.68rem">${t.statut||'â€”'}</span></td>
      <td><span class="pill" style="background:${pb};color:${pc};font-size:.68rem">${t.priorite||'â€”'}</span></td>
      <td style="font-size:.73rem;color:var(--mu);max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${(t.commentaires||'').replace(/"/g,'&quot;')}">${t.commentaires||'â€”'}</td>
      <td>
        <div style="display:flex;gap:5px;flex-shrink:0">
          <button class="btn bgh bsm" onclick="editTache(${idx})" title="Modifier">âœï¸</button>
          <button class="btn br bsm" onclick="confirmDel('tache',${idx})" title="Supprimer">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--mu)">Aucune tÃ¢che</td></tr>`;
  renderPag('pgt',fT.length,pt,v=>{pt=v;renderTT();});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPIs & CHARTS TÃ‚CHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKT(){
  const tot=T.length;
  const term=T.filter(x=>x.statut==='TerminÃ©e').length;
  const ec=T.filter(x=>x.statut==='En cours').length;
  const af=T.filter(x=>x.statut==='Ã€ faire').length;
  g('tv0').textContent=tot; g('tv1').textContent=term; g('tv2').textContent=ec; g('tv3').textContent=af;
  g('tp1').textContent=pct(term,tot); g('tp2').textContent=pct(ec,tot); g('tp3').textContent=pct(af,tot);
  g('tb1f').style.width=pct(term,tot); g('tb2f').style.width=pct(ec,tot); g('tb3f').style.width=pct(af,tot);
  g('nb-t').textContent=tot;
}
function kpiT(s,el){
  akT=(akT===s)?'':s;
  document.querySelectorAll('#tab-taches .kpi').forEach(k=>k.classList.remove('on'));
  if(akT) el.classList.add('on');
  applyFT();
}
function drawChT(){
  const sc={'Ã€ faire':0,'En cours':0,'TerminÃ©e':0,'AnnulÃ©':0};
  T.forEach(t=>{if(sc[t.statut]!==undefined)sc[t.statut]++;else sc['AnnulÃ©']++;});
  if(chT1)chT1.destroy();
  chT1=new Chart(g('cht1'),{type:'doughnut',data:{labels:Object.keys(sc),datasets:[{data:Object.values(sc),backgroundColor:['#b07d0a','#1c5fad','#0e7a45','#c0392b'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:8,font:{size:10,family:'DM Sans'}}}}}});
  const cc={};T.forEach(t=>{if(t.commission)cc[t.commission]=(cc[t.commission]||0)+1;});
  const ck=Object.keys(cc);
  if(chT2)chT2.destroy();
  chT2=new Chart(g('cht2'),{type:'bar',data:{labels:ck,datasets:[{data:ck.map(k=>cc[k]),backgroundColor:ck.map(k=>CMAP[k]?.col||'#6b7d8f'),borderRadius:5,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1,font:{family:'DM Sans',size:10}}},x:{ticks:{font:{family:'DM Sans',size:9}},grid:{display:false}}}}});
}
function applyFT(){
  const q=g('ts').value.toLowerCase().trim();
  const es=akT||g('tfs').value, ec=g('tfc').value, ep=g('tfp').value;
  fT=T.filter(t=>{
    if(q&&![t.activite,t.commission,t.responsable,t.commentaires||''].join(' ').toLowerCase().includes(q))return false;
    if(es&&t.statut!==es)return false;
    if(ec&&t.commission!==ec)return false;
    if(ep&&t.priorite!==ep)return false;
    return true;
  });
  fT.sort((a,b)=>String(a[scT]).localeCompare(String(b[scT]),'fr',{numeric:true})*sdT);
  pt=1; g('rct').textContent=fT.length+' tÃ¢che'+(fT.length>1?'s':'');
  renderTT();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGINATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPag(id,total,cur,cb){
  const pages=Math.ceil(total/PS);
  if(pages<=1){g(id).innerHTML=`<span class="pi">${total} rÃ©sultat(s)</span>`;return;}
  let h=`<button ${cur===1?'disabled':''} onclick="(${cb})(1)">Â«</button>`;
  h+=`<button ${cur===1?'disabled':''} onclick="(${cb})(${cur-1})">â€¹</button>`;
  for(let i=Math.max(1,cur-2);i<=Math.min(pages,cur+2);i++)
    h+=`<button class="${i===cur?'on':''}" onclick="(${cb})(${i})">${i}</button>`;
  h+=`<button ${cur===pages?'disabled':''} onclick="(${cb})(${cur+1})">â€º</button>`;
  h+=`<button ${cur===pages?'disabled':''} onclick="(${cb})(${pages})">Â»</button>`;
  h+=`<span class="pi">${(cur-1)*PS+1}â€“${Math.min(cur*PS,total)} sur ${total}</span>`;
  g(id).innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARTE OSM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap(){
  mapI=L.map('map',{center:[46.8,2.5],zoom:5});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap',maxZoom:19}).addTo(mapI);
  updateMap();
}
function updateMap(){
  if(!mapI) return;
  if(mCluster) mapI.removeLayer(mCluster);
  mCluster=L.markerClusterGroup({
    maxClusterRadius:60,disableClusteringAtZoom:13,
    iconCreateFunction:cl=>{
      const cnt=cl.getChildCount(), sz=cnt>10?52:cnt>5?44:38;
      return L.divIcon({html:`<div style="width:${sz}px;height:${sz}px;border-radius:50%;background:#0e7a45;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:${cnt>9?13:14}px;color:#fff;font-family:'DM Sans',sans-serif">${cnt}</div>`,className:'',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
    }
  });
  const fs=g('mfs').value,fd=g('mfd').value,fq=g('mfq').value,q=(g('ms').value||'').toLowerCase().trim();
  M.filter(r=>{
    if(fs&&r.statut!==fs)return false;
    if(fd&&r.direction!==fd)return false;
    if(fq&&r.quartier!==fq)return false;
    if(q&&![r.nom,r.prenom,r.ville].join(' ').toLowerCase().includes(q))return false;
    return true;
  }).forEach(r=>{
    const coords=gc(r.ville); if(!coords) return;
    const c=ac(r.nom);
    const mk=L.marker(coords,{icon:L.divIcon({html:`<div style="width:34px;height:34px;border-radius:50%;background:${c};border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;color:#fff;font-family:'DM Sans',sans-serif">${ini(r.nom,r.prenom)}</div>`,className:'',iconSize:[34,34],iconAnchor:[17,17]})});
    mk.bindPopup(`<div style="font-family:'DM Sans',sans-serif;min-width:160px"><b style="font-size:.88rem">${r.nom} ${r.prenom}</b><div style="color:#6b7d8f;font-size:.75rem;margin:2px 0">${r.ville} Â· ${r.annee_arrivee||'â€”'}</div><div style="font-size:.75rem">${r.statut}</div></div>`);
    mCluster.addLayer(mk);
  });
  mapI.addLayer(mCluster);
}
function buildQBar(){
  const qs=[...new Set(M.map(r=>r.quartier).filter(Boolean))].sort();
  g('qbar').innerHTML=qs.map(q=>`<button class="qc" onclick="this.classList.toggle('on');updateMap()" data-q="${q}">${q}</button>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÃ‰TAIL MEMBRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDM(idx){
  const r=M[idx], c=ac(r.nom);
  g('det-av').style.background=c; g('det-av').style.fontSize='';
  g('det-av').textContent=ini(r.nom,r.prenom);
  g('det-nm').textContent=(r.nom||'')+' '+(r.prenom||'');
  g('det-sub').textContent=(r.ville||'')+(r.ville&&r.statut?' Â· ':'')+r.statut;
  g('det-grid').innerHTML=[
    ['TÃ©lÃ©phone',r.telephone||'â€”'],['Email',r.email||'â€”'],
    ['Sexe',r.sexe||'â€”'],['Statut',r.statut||'â€”'],
    ['SpÃ©cialitÃ©',r.specialite||'â€”'],['PrÃ©sentation',r.presentation||'â€”'],
    ['Quartier',r.quartier||'â€”'],['AnnÃ©e arrivÃ©e',r.annee_arrivee||'â€”'],
    ['Participation',r.direction||'â€”'],['VÃ©rification',r.verification||'â€”'],
    ['Date inscription',r.date_inscription||'â€”'],
  ].map(([l,v])=>`<div class="di"><div class="dl">${l}</div><div class="dv">${v}</div></div>`).join('');
  openOv('det');
}
function showDT(idx){
  const t=T[idx];
  const cm=CMAP[t.commission]||{col:'#6b7d8f',bg:'#f0f4f8',ico:'ğŸ“‹'};
  g('det-av').style.background=cm.col; g('det-av').style.fontSize='1.2rem';
  g('det-av').textContent=cm.ico;
  g('det-nm').textContent=t.activite||'';
  g('det-sub').textContent=(t.commission||'')+(t.commission&&t.statut?' Â· ':'')+t.statut;
  g('det-grid').innerHTML=[
    ['ID',t.id||'â€”'],['Commission',t.commission||'â€”'],
    ['Responsable',t.responsable||'â€”'],['Date dÃ©but',t.date_debut||'â€”'],
    ['Date fin',t.date_fin||'â€”'],['Statut',t.statut||'â€”'],
    ['PrioritÃ©',t.priorite||'â€”'],['Commentaires',t.commentaires||'â€”'],
  ].map(([l,v])=>`<div class="di"><div class="dl">${l}</div><div class="dv" style="white-space:pre-line">${v}</div></div>`).join('');
  openOv('det');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AJOUT / EDITION MEMBRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMembre(){
  const nom=g('am-nom').value.trim().toUpperCase();
  const prenom=g('am-prenom').value.trim();
  if(!nom||!prenom){toast('âš ï¸ Nom et PrÃ©nom requis','#c0392b');return;}
  M.push({
    nom,prenom,
    sexe:g('am-sexe').value, ville:g('am-ville').value.trim(),
    telephone:g('am-telephone').value.trim(), email:g('am-email').value.trim(),
    annee_arrivee:g('am-annee_arrivee').value, statut:g('am-statut').value,
    specialite:g('am-specialite').value.trim(), quartier:g('am-quartier').value.trim(),
    direction:g('am-direction').value, verification:g('am-verification').value,
    date_inscription:nowFR(),
  });
  closeOv('am'); refreshAll(); toast('âœ… '+nom+' '+prenom+' ajoutÃ©(e) !');
  ['am-nom','am-prenom','am-ville','am-telephone','am-email','am-annee_arrivee','am-specialite','am-quartier'].forEach(id=>{g(id).value='';});
}

function editMembre(idx){
  emiIdx=idx; const r=M[idx];
  ['nom','prenom','sexe','ville','telephone','email','annee_arrivee','statut','specialite','quartier','direction','verification'].forEach(k=>{
    const el=g('em-'+k); if(el) el.value=r[k]||'';
  });
  openOv('em');
}
g('em-ok').addEventListener('click',()=>{
  if(emiIdx<0) return;
  ['nom','prenom','sexe','ville','telephone','email','annee_arrivee','statut','specialite','quartier','direction','verification'].forEach(k=>{
    const el=g('em-'+k); if(el) M[emiIdx][k]=el.value.trim();
  });
  closeOv('em'); refreshAll(); toast('âœ… Membre mis Ã  jour !');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AJOUT / EDITION TÃ‚CHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addTache(){
  const act=g('at-activite').value.trim();
  if(!act){toast('âš ï¸ ActivitÃ© requise','#c0392b');return;}
  T.push({
    id:genId(), activite:act, commission:g('at-commission').value,
    responsable:g('at-responsable').value.trim(),
    date_debut:toFR(g('at-date_debut').value), date_fin:toFR(g('at-date_fin').value),
    statut:g('at-statut').value, relance:'', priorite:g('at-priorite').value,
    commentaires:g('at-commentaires').value.trim(),
  });
  closeOv('at'); refreshTaches(); toast('âœ… TÃ¢che ajoutÃ©e !');
  ['at-activite','at-responsable','at-date_debut','at-date_fin','at-commentaires'].forEach(id=>{g(id).value='';});
}

function editTache(idx){
  etiIdx=idx; const t=T[idx];
  g('et-activite').value=t.activite||'';
  g('et-commission').value=t.commission||'SecrÃ©tariat';
  g('et-responsable').value=t.responsable||'';
  g('et-date_debut').value=toISO(t.date_debut);
  g('et-date_fin').value=toISO(t.date_fin);
  g('et-statut').value=t.statut||'Ã€ faire';
  g('et-priorite').value=t.priorite||'Moyenne';
  g('et-commentaires').value=t.commentaires||'';
  openOv('et');
}
g('et-ok').addEventListener('click',()=>{
  if(etiIdx<0) return;
  T[etiIdx].activite    = g('et-activite').value.trim();
  T[etiIdx].commission  = g('et-commission').value;
  T[etiIdx].responsable = g('et-responsable').value.trim();
  T[etiIdx].date_debut  = toFR(g('et-date_debut').value);
  T[etiIdx].date_fin    = toFR(g('et-date_fin').value);
  T[etiIdx].statut      = g('et-statut').value;
  T[etiIdx].priorite    = g('et-priorite').value;
  T[etiIdx].commentaires= g('et-commentaires').value.trim();
  closeOv('et'); refreshTaches(); toast('âœ… TÃ¢che mise Ã  jour !');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPPRESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmDel(type,idx){
  const name = type==='membre' ? (M[idx].nom+' '+M[idx].prenom) : T[idx].activite;
  g('del-msg').textContent = `Supprimer "${name}" ? Cette action est irrÃ©versible.`;
  delFn = ()=>{
    if(type==='membre'){ M.splice(idx,1); refreshAll(); toast('ğŸ—‘ï¸ Membre supprimÃ©.'); }
    else { T.splice(idx,1); refreshTaches(); toast('ğŸ—‘ï¸ TÃ¢che supprimÃ©e.'); }
    closeOv('del');
  };
  openOv('del');
}
g('del-ok').addEventListener('click',()=>{if(delFn)delFn();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshTaches(){
  updateKT(); drawChT(); applyFT(); g('nb-t').textContent=T.length;
}
function refreshAll(){
  updateKM(); drawChM(); initSelects(); applyFM(); applyFM2();
  buildQBar(); updateMap();
  refreshTaches();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTS CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function expCSV(type){
  let data, cols, heads, fn;
  if(type==='membres'||type==='liste'){
    data=fM.length?fM:M;
    cols=['nom','prenom','sexe','ville','telephone','email','annee_arrivee','statut','specialite','quartier','direction','verification','date_inscription'];
    heads=['Nom','PrÃ©nom','Sexe','Ville','TÃ©lÃ©phone','Email','AnnÃ©e arrivÃ©e','Statut','SpÃ©cialitÃ©','Quartier','Participation','VÃ©rification','Date inscription'];
    fn='AKF_membres';
  } else {
    data=fT.length?fT:T;
    cols=['id','activite','commission','responsable','date_debut','date_fin','statut','priorite','relance','commentaires'];
    heads=['ID','ActivitÃ©','Commission','Responsable','Date dÃ©but','Date fin','Statut','PrioritÃ©','Relance','Commentaires'];
    fn='AKF_taches';
  }
  let csv=heads.join(';')+'\n';
  data.forEach(r=>csv+=cols.map(c=>`"${String(r[c]||'').replace(/"/g,'""')}"`).join(';')+'\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'}));
  a.download=`${fn}_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init(){
  g('ldov').classList.remove('hide');
  g('ldtxt').textContent = 'Chargement des donnÃ©esâ€¦';

  // Tentative de sync Google Sheets
  let synced = false;
  try {
    const [respM, respT] = await Promise.all([
      fetch(csvURL(CFG.membres.id, CFG.membres.sheet)),
      fetch(csvURL(CFG.taches.id, CFG.taches.sheet))
    ]);
    if(respM.ok){
      const raw=parseCSV(await respM.text());
      const mapped=raw.map(mapMembre).filter(m=>m.nom);
      if(mapped.length){ M=mapped; synced=true; }
    }
    if(respT.ok){
      const raw=parseCSV(await respT.text());
      const mapped=raw.map(mapTache).filter(t=>t.activite);
      if(mapped.length){ T=mapped; synced=true; }
    }
  } catch(e){ console.warn('Init sync failed, using local data'); }

  g('ldov').classList.add('hide');
  g('sfoot').textContent = synced
    ? 'Google Sheets Â· '+new Date().toLocaleTimeString('fr-FR')
    : 'DonnÃ©es locales Â· '+new Date().toLocaleDateString('fr-FR');

  refreshAll();
  initMap();

  if(synced) toast(`âœ… ${M.length} membres Â· ${T.length} tÃ¢ches chargÃ©s`, '#0e7a45');
})();
</script>
</body>
</html>